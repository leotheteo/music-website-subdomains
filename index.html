<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>csv browser with metadata panel</title>
<style>
body { font-family:sans-serif; background:#111; color:#eee; margin:0; padding:0; }
.container { display:flex; height:100vh; }
.sidebar { width:300px; overflow:auto; background:#222; padding:10px; }
ul { list-style:none; padding-left:20px; margin:0; }
li { cursor:pointer; padding:2px 5px; user-select:none; transition: background 0.2s; }
li:hover { background:#333; }
.folder::before { content:"üìÅ "; display:inline-block; width:20px; transition: transform 0.2s; }
.folder.open::before { content:"üìÇ "; }
.file::before { content:"üìÑ "; display:inline-block; width:20px; }
.subtree { overflow:hidden; transition: max-height 0.3s ease; max-height:0; }
.subtree.open { max-height:1000px; }
.content { flex:1; padding:10px; overflow:auto; position:relative; }
table { border-collapse: collapse; width:100%; margin-top:10px; }
th, td { border: 1px solid #555; padding:4px 8px; text-align:left; }
th { background:#333; cursor:pointer; position:sticky; top:0; z-index:1; }
tr:nth-child(even) { background:#1a1a1a; }
input#csvSearch, input#sidebarSearch { width: 100%; padding:5px; margin-bottom:10px; background:#222; color:#eee; border:1px solid #555; }
.metadata-panel {
  position:absolute;
  top:10px;
  right:10px;
  background:#222;
  border:1px solid #555;
  padding:8px 12px;
  border-radius:8px;
  box-shadow:0 0 10px #000;
  color:#eee;
  max-width:200px;
  pointer-events:none;
}
</style>
</head>
<body>

<div class="container">
  <div class="sidebar">
    <input type="text" id="sidebarSearch" placeholder="search files/folders...">
    <div id="sidebarRoot"></div>
  </div>
  <div class="content" id="csv-content">
    <p>select a file to preview</p>
    <div class="metadata-panel" id="metadataPanel" style="display:none;"></div>
  </div>
</div>

<script>
async function initSidebar() {
  const res = await fetch('href.txt');
  const text = await res.text();
  const lines = text.split('\n');
  const paths = lines.map(l => {
    const match = l.match(/href="([^"]+)"/);
    return match ? match[1] : null;
  }).filter(Boolean);

  const tree = buildTreeFromPaths(paths);
  const sidebarRoot = document.getElementById('sidebarRoot');
  sidebarRoot.appendChild(buildSidebarTree(tree));
}

function buildTreeFromPaths(paths) {
  const tree = {};
  paths.forEach(p => {
    const parts = p.split('/');
    let node = tree;
    parts.forEach((part, i) => {
      if (i === parts.length - 1) node[part] = p;
      else { node[part] = node[part] || {}; node = node[part]; }
    });
  });
  return tree;
}

function buildSidebarTree(obj) {
  const ul = document.createElement('ul');
  for (const key in obj) {
    const li = document.createElement('li');
    let displayName = key.replace(/\.csv$/i,'');
    li.textContent = displayName;
    if (typeof obj[key] === 'string') {
      li.classList.add('file');
      li.dataset.path = obj[key];
    } else {
      li.classList.add('folder');
      const subtree = buildSidebarTree(obj[key]);
      subtree.classList.add('subtree');
      li.appendChild(subtree);
      li.addEventListener('click', e => {
        if (e.target === li) { li.classList.toggle('open'); subtree.classList.toggle('open'); }
      });
    }
    ul.appendChild(li);
  }
  return ul;
}

// filter sidebar
function filterSidebar(element, query) {
  let visible = false;
  element.querySelectorAll(':scope > li').forEach(li => {
    const text = li.firstChild.textContent.toLowerCase();
    let childVisible = true;
    const subtree = li.querySelector(':scope > .subtree');
    if (subtree) childVisible = filterSidebar(subtree, query);
    const match = text.includes(query.toLowerCase());
    li.style.display = (match || childVisible) ? '' : 'none';
    visible = visible || match || childVisible;
  });
  return visible;
}

document.getElementById('sidebarSearch').addEventListener('input', e => filterSidebar(document.getElementById('sidebarRoot'), e.target.value));

const csvContent = document.getElementById('csv-content');
const metadataPanel = document.getElementById('metadataPanel');

document.getElementById('sidebarRoot').addEventListener('click', e => {
  const li = e.target.closest('li.file');
  if (!li) return;
  const path = li.dataset.path;

  fetch(path).then(r => r.text()).then(text => {
    const rows = text.split('\n').filter(r=>r.trim()!=='');
    // show metadata panel
    metadataPanel.style.display = 'block';
    metadataPanel.innerHTML = `
      <strong>${li.textContent}</strong><br>
      Rows: ${rows.length-1}<br>
      Size: ${new Blob([text]).size} bytes
    `;
    // render table
    let html = '<input type="text" id="csvSearch" placeholder="search table...">';
    html += '<table id="csvTable"><thead><tr>';
    rows[0].split(',').forEach((h,i) => html+=`<th data-col="${i}">${h}</th>`);
    html += '</tr></thead><tbody>';
    rows.slice(1).forEach(row=>{
      html+='<tr>';
      row.split(',').forEach(col=>html+=`<td>${col}</td>`);
      html+='</tr>';
    });
    html+='</tbody></table>';
    csvContent.innerHTML = html;

    const table = document.getElementById('csvTable');
    table.querySelectorAll('th').forEach(th=>th.addEventListener('click',()=>sortTable(table, th.dataset.col)));
    document.getElementById('csvSearch').addEventListener('input', e => filterTable(table, e.target.value));
  }).catch(err=>{
    csvContent.innerHTML='<p style="color:red;">failed to load csv</p>';
    console.error(err);
    metadataPanel.style.display='none';
  });
});

// sorting
function sortTable(table, colIndex) {
  const rows = Array.from(table.querySelectorAll('tr:nth-child(n+2)'));
  const asc = table.dataset.sortAsc!=="true";
  rows.sort((a,b)=>{
    const aText = a.children[colIndex].textContent;
    const bText = b.children[colIndex].textContent;
    return asc ? aText.localeCompare(bText) : bText.localeCompare(aText);
  });
  rows.forEach(r=>table.appendChild(r));
  table.dataset.sortAsc=asc;
}

// filter table
function filterTable(table, query) {
  const rows = table.querySelectorAll('tr:nth-child(n+2)');
  rows.forEach(r=>{
    r.style.display = Array.from(r.children).some(td=>td.textContent.toLowerCase().includes(query.toLowerCase()))?'':'none';
  });
}

initSidebar();
</script>

</body>
</html>
